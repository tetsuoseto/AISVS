# C2 ユーザー入力検証

## 制御目標

ユーザー入力の堅牢な検証は、AIシステムに対する最も破壊的な攻撃のいくつかに対する最前線の防御手段です。プロンプトインジェクション攻撃は、システム指示を上書きしたり、機密データを漏洩させたり、モデルを許可されていない動作に誘導したりする可能性があります。専用のフィルターやその他の検証が実施されていない場合、コンテキストウィンドウを悪用する脱獄手法は引き続き有効であることが研究により示されています。

---

## C2.1 プロンプトインジェクション防御

プロンプトインジェクションは、AIシステムにおける主要なリスクの一つです。この手法に対する防御は、パターンフィルター、データ分類器、および命令階層の強制を組み合わせて行われます。

|   #   | 説明                                                                                                                                                                                                                                                         | レベル | 役割  |
| :---: | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :-: | :-: |
| 2.1.1 | ユーザーのプロンプト、RAG結果、プラグインやMCPの出力、エージェント間メッセージ、APIやWebhookのレスポンス、設定やポリシーファイル、メモリの読み取りおよび書き込みなど、動作を誘導する可能性のある外部または派生入力はすべて、信頼されないものとして扱い、引用やタグ付け、アクティブコンテンツの除去によって無効化し、連結してプロンプトに組み込む前や実行アクションの前に、維持管理されたプロンプトインジェクション検出ルールセットまたはサービスによってスクリーニングされることを検証してください。 |  1  | D/V |
| 2.1.2 | システムが、システムおよび開発者のメッセージがユーザーの指示やその他の信頼できない入力よりも優先される指示の階層を適用し、ユーザーの指示を処理した後でもこれを維持していることを検証してください。                                                                                                                                                          |  1  | D/V |
| 2.1.3 | サードパーティのコンテンツ（ウェブページ、PDF、メール）から発信されたプロンプトが、メインプロンプトに連結される前に、指示的な命令を除去し、HTML、Markdown、スクリプトの内容を無効化するなどの方法で、単独で適切にサニタイズ（無害化）されていることを確認してください。                                                                                                                |  2  |  D  |

---

## C2.2 敵対的サンプルへの耐性

自然言語処理（NLP）モデルは、人間が見逃しがちな微妙な文字や単語レベルの摂動に対して依然として脆弱であり、モデルは誤分類する傾向があります。

|   #   | 説明                                                                                                                                                      | レベル | 役割  |
| :---: | ------------------------------------------------------------------------------------------------------------------------------------------------------- | :-: | :-: |
| 2.2.1 | 基本的な入力正規化の手順（Unicode NFC、同形字マッピング、空白のトリミング、制御文字および不可視Unicode文字の除去）が、トークン化または埋め込みの前、およびツールまたはMCP引数への解析の前に実行されることを確認してください。                               |  1  |  D  |
| 2.2.2 | 統計的異常検知が、言語規範から異常に高い編集距離を持つ入力や異常な埋め込み距離を持つ入力をフラグ付けし、フラグ付けされた入力がプロンプトへの連結やアクションの実行前にゲート処理されることを確認してください。                                                 |  2  | D/V |
| 2.2.3 | 推論パイプラインが、高リスクエンドポイント向けに敵対的訓練で強化されたモデルのバリアントや、防御層（例：ランダム化、防御的蒸留、アライメントチェック）をサポートしていることを確認してください。                                                        |  2  |  D  |
| 2.2.4 | 疑わしい敵対的入力が隔離され、完全なペイロードとトレースメタデータ（ソース、ツールまたはMCPサーバー、エージェントID、セッション）と共にログに記録されていることを確認してください。                                                            |  2  |  V  |
| 2.2.5 | 入力および出力の両方におけるエンコーディングおよび表現のすり抜け（例：不可視のUnicode／制御文字、ホモグリフの置換、混在方向テキスト）が検出および軽減されていることを検証してください。承認された軽減方法には、正規化、厳格なスキーマ検証、ポリシーに基づく拒否、または明示的なマーキングが含まれます。 |  2  | D/V |

---

## C2.3 プロンプト文字セット

ユーザー入力の文字セットを、ビジネス要件に必要な文字のみに制限することは、さまざまな種類の攻撃を防ぐのに役立ちます。

|   #   | 説明                                                                                        | レベル | 役割  |
| :---: | ----------------------------------------------------------------------------------------- | :-: | :-: |
| 2.3.1 | システムがユーザー入力に対して文字セットの制限を実装しており、業務上明示的に必要な文字のみを許可していることを確認してください。                          |  1  |  D  |
| 2.3.2 | 許可された文字セットを定義するために、許可リスト方式が使用されていることを確認してください。                                            |  1  |  D  |
| 2.3.3 | 許可されたセット外の文字を含む入力が拒否され、トレースメタデータ（ソース、ツールまたはMCPサーバー、エージェントID、セッション）と共にログに記録されることを確認してください。 |  1  | D/V |

---

## C2.4 スキーマ、型および長さの検証

不正な形式や過剰なサイズの入力を伴うAI攻撃は、パースエラー、フィールド間のプロンプトの漏出、およびリソースの枯渇を引き起こす可能性があります。 また、決定論的なツール呼び出しを行う際には、厳格なスキーマの適用も前提条件となります。

|   #   | 説明                                                                                                                                                            | レベル | 役割  |
| :---: | ------------------------------------------------------------------------------------------------------------------------------------------------------------- | :-: | :-: |
| 2.4.1 | すべてのAPI、ツール、またはMCPエンドポイントが明示的な入力スキーマ（JSON Schema、Protobuf、またはマルチモーダルの同等物）を定義し、余分なフィールドや不明なフィールドを拒否し、暗黙の型変換を行わず、プロンプトの組み立てやツールの実行前にサーバー側で入力を検証していることを確認してください。 |  1  |  D  |
| 2.4.2 | 最大トークン数またはバイト数の制限を超える入力が、安全なエラーで拒否され、決して無言で切り捨てられないことを確認してください。                                                                                               |  1  | D/V |
| 2.4.3 | ツールやMCPの引数を含め、型チェック（例：数値の範囲、列挙型の値、画像/音声のMIMEタイプなど）がサーバー側で強制されていることを確認してください。                                                                                  |  2  | D/V |
| 2.4.4 | NLP入力を理解するセマンティックバリデータが、一定時間内に実行され、アルゴリズム的DoSを防ぐために外部ネットワーク呼び出しを回避していることを検証してください。                                                                            |  2  |  D  |
| 2.4.5 | 検証エラーが、編集されたペイロードの抜粋と明確なエラーコードとともにログに記録され、セキュリティトリアージを支援するためにトレースメタデータ（ソース、ツールまたはMCPサーバー、エージェントID、セッション）が含まれていることを確認してください。                                   |  3  |  V  |

---

## C2.5 コンテンツ＆ポリシースクリーニング

開発者は、不正な指示、ヘイトスピーチ、著作権で保護されたテキストなどの禁止されたコンテンツを要求する構文的に有効なプロンプトを検出し、それらが拡散するのを防止できるようにするべきです。

|   #   | 説明                                                                                                                                         | レベル | 役割  |
| :---: | ------------------------------------------------------------------------------------------------------------------------------------------ | :-: | :-: |
| 2.5.1 | コンテンツ分類器（ゼロショットまたはファインチューニング済み）が、暴力、自傷、ヘイト、性的コンテンツ、および違法なリクエストについて、設定可能な閾値に基づいてすべての入力と出力を評価することを検証してください。                                  |  1  |  D  |
| 2.5.2 | ポリシーに違反する入力は拒否され、下流のLLMやツール/MCPコールに伝播しないことを確認してください。                                                                                       |  1  | D/V |
| 2.5.3 | リクエスト時にエージェント役割属性を含む属性ベースのルールで解決される、ユーザー固有のポリシー（年齢、地域の法的制約）を遵守していることを検証します。                                                                |  2  |  D  |
| 2.5.4 | スクリーニングログに、分類器の信頼度スコアと適用されたステージ（プリプロンプトまたはポストレスポンス）、およびSOC相関と将来のレッドチーム再生のためのトレースメタデータ（ソース、ツールまたはMCPサーバー、エージェントID、セッション）が含まれていることを確認してください。 |  3  |  V  |

---

## C2.6 入力レート制限と乱用防止

開発者は、入力レートを制限し、異常な使用パターンを検出することで、AIシステムに対する悪用、リソース枯渇、および自動化攻撃を防止する必要があります。

|   #   | 説明                                                                                                                                | レベル | 役割  |
| :---: | --------------------------------------------------------------------------------------------------------------------------------- | :-: | :-: |
| 2.6.1 | すべての入力およびツール/MCPエンドポイントに対して、ユーザーごと、IPごと、APIキーごと、エージェントごと、セッション/タスクごとのレート制限が適用されていることを検証してください。                                    |  1  | D/V |
| 2.6.2 | バーストおよび持続的なレート制限がDoS攻撃およびブルートフォース攻撃を防止するように調整されていること、またエージェントのプランニングループに対してタスクごとの予算（例：トークン、ツール/MCPコール、およびコスト）が適用されていることを確認してください。 |  2  | D/V |
| 2.6.3 | 異常な使用パターン（例：連続的なリクエスト、入力の過剰送信、繰り返し失敗するツール/MCP呼び出し、または再帰的なエージェントループ）が自動的なブロックやエスカレーションを引き起こすことを確認してください。                           |  2  | D/V |
| 2.6.4 | 悪用防止ログが保持され、新たな攻撃パターンのためにトレースメタデータ（ソース、ツールまたはMCPサーバー、エージェントID、セッション）とともにレビューされていることを確認してください。                                     |  3  |  V  |

---

## C2.7 マルチモーダル入力検証

AIシステムは、注入、回避、またはリソースの乱用を防ぐために、非テキスト入力（画像、音声、ファイル）に対して堅牢な検証を含めるべきです。

|   #   | 説明                                                                                                                                                                     | レベル | 役割  |
| :---: | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :-: | :-: |
| 2.7.1 | すべての非テキスト入力（画像、音声、ファイル）が処理前にタイプ、サイズ、およびフォーマットについて検証されていること、また抽出されたテキスト（画像からテキストへの変換や音声からテキストへの変換）や隠された指示（メタデータ、レイヤー、代替テキスト、コメント）が2.1.1に従い信頼されないものとして扱われていることを確認してください。 |  1  |  D  |
| 2.7.2 | ファイルが取り込み前にマルウェアおよびステガノグラフィックペイロードのスキャンを受けていることを確認し、スクリプトやマクロのようなアクティブコンテンツが削除されているか、またはファイルが隔離されていることを確認してください。                                                       |  2  | D/V |
| 2.7.3 | 画像や音声の入力が敵対的摂動や既知の攻撃パターンについて検査され、その検出がモデルの使用前にゲーティング（機能のブロックまたは劣化）を引き起こすことを検証してください。                                                                                   |  2  | D/V |
| 2.7.4 | マルチモーダル入力検証の失敗がログに記録され、調査のためのアラートがトリガーされることを確認し、トレースメタデータ（ソース、ツールまたはMCPサーバー、エージェントID、セッション）を付与すること。                                                                    |  3  |  V  |
| 2.7.5 | クロスモーダル攻撃検出が、複数の入力タイプにまたがる連携攻撃（例：画像内のステガノグラフィックペイロードとテキスト内のプロンプトインジェクションの組み合わせ）を相関ルールとアラート生成によって特定し、確定された検出がブロックされるかまたはHITL（ヒューマン・イン・ザ・ループ）承認を必要とすることを検証してください。        |  2  | D/V |
| 2.7.6 | マルチモーダル検証の失敗が、すべての入力モダリティ、検証結果および脅威スコア、トレースメタデータ（ソース、ツールまたはMCPサーバー、エージェントID、セッション）を含む詳細なログ記録を引き起こすことを確認してください。                                                         |  3  | D/V |
---

## C2.8 リアルタイム適応型脅威検出

開発者は、新しい攻撃パターンに適応し、コンパイルされたパターンマッチングによるリアルタイム保護を提供する高度な脅威検出システムをAIに対して導入すべきです。

|   #   | 説明                                                                                                                     | レベル | 役割  |
| :---: | ---------------------------------------------------------------------------------------------------------------------- | :-: | :-: |
| 2.8.1 | パターンマッチング（例：コンパイル済み正規表現）が、すべての入力および出力（ツール/MCPのインターフェースを含む）で最小限のレイテンシー影響で実行されることを検証してください。                              |  1  | D/V |
| 2.8.3 | 適応検出モデルが最近の攻撃活動に基づいて感度を調整し、新しいパターンでリアルタイムに更新されることを確認し、リスク適応型の対応（例えば、ツールの無効化、コンテキストの縮小、または人的監督承認の要求）をトリガーすることを検証してください。 |  2  | D/V |
| 2.8.4 | ユーザーの履歴、ソース、およびセッションの動作（トレースメタデータ（ソース、ツールまたはMCPサーバー、エージェントID、セッション）を含む）に基づくコンテキスト分析により検出精度が向上していることを検証してください。          |  3  | D/V |
| 2.8.5 | 検出性能指標（検出率、誤検知率、処理遅延時間）が継続的に監視および最適化されていることを検証し、ブロックまでの時間および段階（プリプロンプト／ポストレスポンス）も含まれていることを確認してください。                    |  3  | D/V |

## 参考文献

* [OWASP LLM01:2025 Prompt Injection](https://genai.owasp.org/llmrisk/llm01-prompt-injection/)
* [LLM Prompt Injection Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/LLM_Prompt_Injection_Prevention_Cheat_Sheet.html)
* [MITRE ATLAS : Adversarial Input Detection](https://atlas.mitre.org/mitigations/AML.M00150)
* [Mitigate jailbreaks and prompt injections](https://docs.anthropic.com/en/docs/test-and-evaluate/strengthen-guardrails/mitigate-jailbreaks)

