# C2 ユーザー入力検証

## 管理目標

ユーザー入力の堅牢な検証は、AIシステムに対する最も致命的な攻撃のいくつかに対する第一の防御線です。プロンプトインジェクション攻撃は、システムの指示を上書きしたり、機密データを漏洩させたり、モデルを許可されていない行動へと誘導したりする可能性があります。専用のフィルターや指示の階層構造が整っていない限り、研究によれば非常に長いコンテキストウィンドウを悪用する「マルチショット」 jailbreak が効果的であることが示されています。また、ホモグリフ置換やリートスピークのような微妙な敵対的摂動攻撃は、モデルの判断を静かに変更することがあります。

---

## C2.1 プロンプトインジェクション防御

プロンプトインジェクションは、AIシステムにおける主要なリスクの一つです。この手法に対する防御は、静的パターンフィルター、動的分類器、および指示階層の強制の組み合わせを用いて行われます。

|   #   | 説明                                                                                                     | レベル | 役割  |
| :---: | ------------------------------------------------------------------------------------------------------ | :-: | :-: |
| 2.1.1 | ユーザー入力が、継続的に更新される既知のプロンプトインジェクションパターン（脱獄キーワード、「前を無視」、ロールプレイチェーン、間接的なHTML/URL攻撃）に対して検査されていることを確認してください。 |  1  | D/V |
| 2.1.2 | システムが、コンテキストウィンドウの拡張後でも、システムまたは開発者メッセージがユーザーの指示を上書きする指示階層を強制していることを確認してください。                           |  1  | D/V |
| 2.1.3 | 敵対的評価テスト（例：Red Teamの「多ショット」プロンプト）が、各モデルまたはプロンプトテンプレートのリリース前に実行されていることを確認し、成功率の閾値と回帰に対する自動ブロッカーを設けること。  |  2  | D/V |
| 2.1.4 | サードパーティのコンテンツ（ウェブページ、PDF、電子メール）から発生するプロンプトが、メインプロンプトに連結される前に、分離された解析コンテキスト内で適切にサニタイズされていることを確認してください。  |  2  |  D  |
| 2.1.5 | すべてのプロンプトフィルタールールの更新、分類器モデルのバージョンおよびブロックリストの変更がバージョン管理され、監査可能であることを確認してください。                           |  3  | D/V |

---

## C2.2 敵対的サンプル耐性

自然言語処理（NLP）モデルは、人間が見落としがちな微妙な文字や単語レベルの摂動に依然として脆弱であり、モデルはそれを誤分類しやすいです。

|   #   | 説明                                                                                         | レベル | 役割  |
| :---: | ------------------------------------------------------------------------------------------ | :-: | :-: |
| 2.2.1 | 基本的な入力正規化手順（Unicode NFC、類似文字のマッピング、空白のトリミング）がトークン化の前に実行されることを確認してください。                     |  1  |  D  |
| 2.2.2 | 統計的異常検出が、言語の標準から著しく高い編集距離、不自然に繰り返されるトークン、または異常な埋め込み距離を持つ入力を正しく検出することを確認してください。             |  2  | D/V |
| 2.2.3 | 推論パイプラインが、高リスクのエンドポイント向けにオプションの敵対的トレーニング強化モデルバリアントや防御層（例：ランダム化、防御的蒸留）をサポートしていることを確認してください。 |  2  |  D  |
| 2.2.4 | 疑わしい敵対的入力が隔離され、完全なペイロード（個人識別情報の削除後）とともにログ記録されていることを確認してください。                               |  2  |  V  |
| 2.2.5 | 既知の攻撃スイートの成功率などのロバストネスメトリクスが時間経過で追跡されており、リグレッションがリリース阻止要因を引き起こすことを確認してください。                |  3  | D/V |

---

## C2.3 スキーマ、タイプおよび長さの検証

不正な形式または過剰なサイズの入力を特徴とするAI攻撃は、パースエラー、フィールド間でのプロンプトの漏れ、およびリソースの枯渇を引き起こす可能性があります。決定論的なツール呼び出しを行う際には、厳格なスキーマの適用も前提条件となります。

|   #   | 説明                                                                                                               | レベル | 役割  |
| :---: | ---------------------------------------------------------------------------------------------------------------- | :-: | :-: |
| 2.3.1 | すべてのAPIまたは関数呼び出しエンドポイントが明示的な入力スキーマ（JSON Schema、Protobuf、またはマルチモーダルの同等物）を定義しており、入力がプロンプト組み立て前に検証されていることを確認してください。 |  1  |  D  |
| 2.3.2 | 最大トークン数またはバイト数の制限を超える入力が、安全なエラーで拒否され、決して無言で切り捨てられないことを確認してください。                                                  |  1  | D/V |
| 2.3.3 | タイプチェック（例：数値範囲、列挙型の値、画像/音声のMIMEタイプ）がクライアントコードだけでなく、サーバー側でも適用されていることを確認してください。                                    |  2  | D/V |
| 2.3.4 | 意味的バリデーター（例：JSON Schema）が定数時間で実行され、アルゴリズム的DoSを防止することを検証してください。                                                   |  2  |  D  |
| 2.3.5 | 検証の失敗が、マスキングされたペイロードの断片と明確なエラーコードとともに記録され、セキュリティのトリアージを支援することを確認してください。                                          |  3  |  V  |

---

## C2.4 コンテンツおよびポリシースクリーニング

開発者は、禁止されている内容（違法な指示、ヘイトスピーチ、著作権で保護されたテキストなど）を要求する構文的に有効なプロンプトを検出し、それが拡散するのを防止できるようにする必要があります。

|   #   | 説明                                                                                                      | レベル | 役割  |
| :---: | ------------------------------------------------------------------------------------------------------- | :-: | :-: |
| 2.4.1 | コンテンツ分類器（ゼロショットまたはファインチューニング済み）が、暴力、自傷、ヘイト、性的コンテンツ、および違法なリクエストについてすべての入力をスコアリングし、設定可能な閾値を備えていることを検証します。 |  1  |  D  |
| 2.4.2 | ポリシーに違反する入力が標準化された拒否応答または安全な完了応答を受け取り、下流の大規模言語モデル（LLM）呼び出しに伝播しないことを確認してください。                            |  1  | D/V |
| 2.4.3 | スクリーニングモデルまたはルールセットが少なくとも四半期ごとに再訓練／更新され、新たに観察されたジャイルブレイクまたはポリシーバイパスのパターンが取り込まれていることを確認してください。           |  2  |  D  |
| 2.4.4 | リクエスト時に解決される属性ベースのルールを通じて、ユーザー固有のポリシー（年齢、地域の法的制約）が遵守されていることを検証します。                                      |  2  |  D  |
| 2.4.5 | スクリーニングログに、SOC相関および将来のレッドチーム再生のための分類器の信頼度スコアとポリシーカテゴリタグが含まれていることを確認してください。                              |  3  |  V  |

---

## C2.5 入力レート制限および不正使用防止

開発者は、入力レートを制限し、異常な使用パターンを検出することで、AIシステムに対する悪用、リソースの枯渇、および自動化攻撃を防止する必要があります。

|   #   | 説明                                                                   | レベル | 役割  |
| :---: | -------------------------------------------------------------------- | :-: | :-: |
| 2.5.1 | すべての入力エンドポイントに対して、ユーザーごと、IPごと、およびAPIキーごとのレート制限が適用されていることを確認してください。   |  1  | D/V |
| 2.5.2 | バーストおよび持続的なレート制限がDoS攻撃およびブルートフォース攻撃を防ぐように適切に調整されていることを確認してください。      |  2  | D/V |
| 2.5.3 | 異常な使用パターン（例：短時間での連続リクエスト、入力洪水）が自動的なブロックまたはエスカレーションを引き起こすことを確認してください。 |  2  | D/V |
| 2.5.4 | 悪用防止ログが保持され、新たな攻撃パターンのためにレビューされていることを確認してください。                       |  3  |  V  |

---

## C2.6 マルチモーダル入力検証

AIシステムは、注入、回避、またはリソース乱用を防ぐために、非テキスト入力（画像、音声、ファイル）に対する堅牢な検証を含めるべきです。

|   #   | 説明                                                                | レベル | 役割  |
| :---: | ----------------------------------------------------------------- | :-: | :-: |
| 2.6.1 | すべての非テキスト入力（画像、音声、ファイル）が処理前に種類、サイズ、およびフォーマットの検証を受けていることを確認してください。 |  1  |  D  |
| 2.6.2 | 取り込み前にファイルがマルウェアおよびステガノグラフィックペイロードのスキャンを受けていることを確認してください。         |  2  | D/V |
| 2.6.3 | 画像/音声入力が敵対的摂動や既知の攻撃パターンに対して検査されていることを確認してください。                    |  2  | D/V |
| 2.6.4 | マルチモーダル入力検証の失敗が記録され、調査のためのアラートが発生することを確認してください。                   |  3  |  V  |

---

## C2.7 入力の出所と帰属

AIシステムは、すべてのユーザー入力の起源を監視およびタグ付けすることで、監査、悪用追跡、およびコンプライアンスをサポートする必要があります。

|   #   | 説明                                                                            | レベル | 役割  |
| :---: | ----------------------------------------------------------------------------- | :-: | :-: |
| 2.7.1 | すべてのユーザー入力が取り込み時にメタデータ（ユーザーID、セッション、ソース、タイムスタンプ、IPアドレス）でタグ付けされていることを検証してください。 |  1  | D/V |
| 2.7.2 | 処理されたすべての入力に対して、来歴メタデータが保持され、監査可能であることを確認してください。                              |  2  | D/V |
| 2.7.3 | 異常または信頼されていない入力ソースが検出され、強化された精査やブロックの対象となることを確認してください。                        |  2  | D/V |

---

## C2.8 リアルタイム適応型脅威検出

開発者は、新しい攻撃パターンに適応し、コンパイルされたパターンマッチングによるリアルタイム保護を提供する高度なAI用脅威検出システムを採用すべきです。

|   #   | 説明                                                                                         | レベル | 役割  |
| :---: | ------------------------------------------------------------------------------------------ | :-: | :-: |
| 2.8.1 | 脅威検出パターンが、高性能なリアルタイムフィルタリングのために最適化された正規表現エンジンにコンパイルされており、レイテンシへの影響が最小限であることを検証してください。      |  1  | D/V |
| 2.8.2 | 脅威検出システムが異なる脅威カテゴリ（プロンプトインジェクション、有害コンテンツ、機密データ、システムコマンド）ごとに別々のパターンライブラリを保持していることを確認してください。 |  1  | D/V |
| 2.8.3 | 適応型脅威検出が、攻撃の頻度と成功率に基づいて脅威の感度を更新する機械学習モデルを組み込んでいることを確認してください。                               |  2  | D/V |
| 2.8.4 | リアルタイムの脅威インテリジェンスフィードが、新しい攻撃シグネチャおよびIOC（侵害の指標）でパターンライブラリを自動的に更新することを確認してください。              |  2  | D/V |
| 2.8.5 | 脅威検出の誤検知率が継続的に監視され、パターンの特異性が正当な利用ケースの干渉を最小限に抑えるよう自動的に調整されていることを確認してください。                   |  3  | D/V |
| 2.8.6 | コンテキストベースの脅威分析が、検出精度を向上させるために入力ソース、ユーザーの行動パターン、セッション履歴を考慮していることを確認してください。                  |  3  | D/V |
| 2.8.7 | 脅威検出のパフォーマンス指標（検出率、処理遅延、リソース利用率）がリアルタイムで監視され、最適化されていることを確認してください。                          |  3  | D/V |

---

## C2.9 マルチモーダルセキュリティ検証パイプライン

開発者は、特定の種類の脅威検出およびリソース分離を用いて、テキスト、画像、音声、その他のAI入力モードに対するセキュリティ検証を提供する必要があります。

|   #   | 説明                                                                                                                      | レベル | 役割  |
| :---: | ----------------------------------------------------------------------------------------------------------------------- | :-: | :-: |
| 2.9.1 | 各入力モダリティに対して、ドキュメント化された脅威パターン（テキスト：プロンプトインジェクション、画像：ステガノグラフィー、オーディオ：スペクトログラム攻撃）および検出閾値を備えた専用のセキュリティバリデータがあることを検証してください。 |  1  | D/V |
| 2.9.2 | マルチモーダル入力が、各モダリティタイプに特有の定義されたリソース制限（メモリ、CPU、処理時間）を持つ分離されたサンドボックス内で処理されていることを確認し、それがセキュリティポリシーに文書化されていることを確認してください。      |  2  | D/V |
| 2.9.3 | クロスモーダル攻撃検出が、複数の入力タイプにまたがる協調攻撃（例：画像内のステガノグラフィックペイロードとテキスト内のプロンプトインジェクションの組み合わせ）を相関ルールとアラート生成によって識別することを検証してください。        |  2  | D/V |
| 2.9.4 | マルチモーダル検証の失敗が、すべての入力モダリティ、検証結果、脅威スコア、および相関分析を含む詳細なログ記録をトリガーし、SIEM統合のための構造化ログ形式であることを確認してください。                           |  3  | D/V |
| 2.9.5 | モダリティ固有のコンテンツ分類器が、文書化されたスケジュール（最低でも四半期ごと）に従って、新しい脅威パターン、敵対的サンプル、およびベースライン閾値以上に維持されるパフォーマンスベンチマークで更新されていることを検証してください。    |  3  | D/V |

---

## 参考文献

* [LLM01:2025 Prompt Injection – OWASP Top 10 for LLM & Generative AI Security](https://genai.owasp.org/llmrisk/llm01-prompt-injection/)
* [Generative AI's Biggest Security Flaw Is Not Easy to Fix](https://www.wired.com/story/generative-ai-prompt-injection-hacking)
* [Many-shot jailbreaking \ Anthropic](https://www.anthropic.com/research/many-shot-jailbreaking)
* [$PDF$ OpenAI GPT-4.5 System Card](https://cdn.openai.com/gpt-4-5-system-card-2272025.pdf)
* [Notebook for the CheckThat Lab at CLEF 2024](https://ceur-ws.org/Vol-3740/paper-53.pdf)
* [Mitigate jailbreaks and prompt injections – Anthropic](https://docs.anthropic.com/en/docs/test-and-evaluate/strengthen-guardrails/mitigate-jailbreaks)
* [Chapter 3 MITRE ATT\&CK – Adversarial Model Analysis](https://ama.drwhy.ai/mitre-attck.html)
* [OWASP Top 10 for LLM Applications 2025 – WorldTech IT](https://wtit.com/blog/2025/04/17/owasp-top-10-for-llm-applications-2025/)
* [OWASP Machine Learning Security Top Ten](https://owasp.org/www-project-machine-learning-security-top-10/)
* [Few words about AI Security – Jussi Metso](https://www.jussimetso.com/index.php/2024/09/28/few-words-about-ai-security/)
* [How To Ensure LLM Output Adheres to a JSON Schema | Modelmetry](https://modelmetry.com/blog/how-to-ensure-llm-output-adheres-to-a-json-schema)
* [Easily enforcing valid JSON schema following – API](https://community.openai.com/t/feature-request-function-calling-easily-enforcing-valid-json-schema-following/263515?utm_source)
* [AI Safety + Cybersecurity R\&D Tracker – Fairly AI](https://www.fairly.ai/blog/ai-cybersecurity-tracker)
* [Anthropic makes 'jailbreak' advance to stop AI models producing harmful results](https://www.ft.com/content/cf11ebd8-aa0b-4ed4-945b-a5d4401d186e)
* [Pattern matching filter rules - IBM](https://www.ibm.com/docs/ssw_aix_71/security/intrusion_pattern_matching_filter_rules.html)
* [Real-time Threat Detection](https://www.darktrace.com/cyber-ai-glossary/real-time-threat-detection)

