# C2 ユーザー入力検証

## 制御目標

ユーザー入力の堅牢な検証は、AIシステムに対する最も被害の大きい攻撃のいくつかに対する最前線の防御手段です。プロンプトインジェクション攻撃は、システムの指示を上書きしたり、機密データを漏洩させたり、モデルを許可されていない行動へ誘導したりする可能性があります。専用のフィルターやその他の検証が行われていない限り、研究によれば、コンテキストウィンドウを悪用する脱獄は引き続き有効であることが示されています。

---

## C2.1 プロンプトインジェクション防御

プロンプトインジェクションは、AIシステムにおける主要なリスクの一つです。この手法に対する防御策は、パターンフィルター、データ分類器、および指示階層の強制を組み合わせて実施されます。

|   #   | 説明                                                                                                                | レベル | 役割  |
| :---: | ----------------------------------------------------------------------------------------------------------------- | :-: | :-: |
| 2.1.1 | ユーザーの入力が、既知のプロンプトインジェクションパターンの継続的に更新されるライブラリに対して検査されていることを確認してください。これには、ジャイルブレイクキーワード、「前の指示を無視」やロールプレイチェーンが含まれます。 |  1  | D/V |
| 2.1.2 | システムが指示ヒエラルキーを適用し、ユーザーの指示を処理した後でもシステムメッセージがユーザーの指示を上書きすることを検証してください。                                              |  1  | D/V |
| 2.1.4 | サードパーティのコンテンツ（ウェブページ、PDF、メール）から生成されたプロンプトが、メインプロンプトに連結される前に個別にサニタイズされていることを確認してください。                              |  2  |  D  |

---

## C2.2 敵対的サンプル耐性

自然言語処理（NLP）モデルは、人間が見落としがちな微細な文字や単語レベルの摂動に対して依然として脆弱であり、モデルは誤分類しやすい。

|   #   | 説明                                                                                                                                                       | レベル | 役割  |
| :---: | -------------------------------------------------------------------------------------------------------------------------------------------------------- | :-: | :-: |
| 2.2.1 | 基本的な入力正規化ステップ（Unicode NFC、同形文字マッピング、空白トリミング）がトークン化の前に実行されることを確認してください。                                                                                   |  1  |  D  |
| 2.2.2 | 統計的異常検出が、言語の規範から異常に高い編集距離または異常な埋め込み距離を持つ入力をフラグ付けすることを検証してください。                                                                                           |  2  | D/V |
| 2.2.3 | 推論パイプラインが、高リスクエンドポイント向けに敵対的訓練で強化されたモデルバリアントや防御レイヤー（例：ランダム化、防御的蒸留、整合性チェック）をサポートしていることを確認してください。                                                           |  2  |  D  |
| 2.2.4 | 疑わしい敵対的入力が隔離され、完全なペイロードとともに記録されていることを確認してください。                                                                                                           |  2  |  V  |
| 2.2.5 | 入力および出力の両方におけるエンコーディングおよび表現の隠ぺい（例：不可視のUnicode/制御文字、ホモグリフの置換、または混合方向テキスト）が検出され、軽減されていることを確認してください。承認された軽減策には、正規化、厳密なスキーマ検証、ポリシーベースの拒否、または明示的なマーキングが含まれます。 |  2  | D/V |

---

## C2.3 スキーマ、タイプおよび長さの検証

不正な形式やサイズが大きすぎる入力によるAI攻撃は、パースエラー、フィールド間のプロンプト溢れ、リソース枯渇を引き起こす可能性があります。決定的なツール呼び出しを行う際には、厳格なスキーマの適用も前提条件です。

|   #   | 説明                                                                                                                   | レベル | 役割  |
| :---: | -------------------------------------------------------------------------------------------------------------------- | :-: | :-: |
| 2.3.1 | すべてのAPIまたは関数呼び出しのエンドポイントが明示的な入力スキーマ（JSONスキーマ、Protobuf、またはマルチモーダルの同等品）を定義していること、およびプロンプトの組み立て前に入力が検証されていることを確認してください。 |  1  |  D  |
| 2.3.2 | 最大トークン数またはバイト数の制限を超える入力が、安全なエラーで拒否され、決して無言で切り捨てられないことを確認してください。                                                      |  1  | D/V |
| 2.3.3 | 型チェック（例：数値範囲、列挙型の値、画像/音声のMIMEタイプ）がサーバー側で強制されていることを確認してください。                                                          |  2  | D/V |
| 2.3.4 | 意味的バリデータ（例：JSON Schema）がアルゴリズム的DoSを防ぐために一定時間で実行されることを検証してください。                                                       |  2  |  D  |
| 2.3.5 | 検証の失敗が、セキュリティのトリアージを支援するために、値が隠されたペイロードの抜粋と明確なエラーコードとともにログ記録されていることを確認してください。                                        |  3  |  V  |

---

## C2.4 コンテンツおよびポリシースクリーニング

開発者は、許可されていない内容（違法な指示、ヘイトスピーチ、および/または著作権で保護されたテキストなど）を要求する構文的に有効なプロンプトを検出し、それらが拡散されるのを防止できるようにする必要があります。

|   #   | 説明                                                                                               | レベル | 役割  |
| :---: | ------------------------------------------------------------------------------------------------ | :-: | :-: |
| 2.4.1 | コンテンツ分類器（ゼロショットまたはファインチューニング済み）が、暴力、自傷、ヘイト、性的コンテンツ、違法な要求について、すべての入力を評価し、設定可能な閾値でスコアリングすることを検証する。 |  1  |  D  |
| 2.4.2 | ポリシーに違反する入力が標準化された拒否応答または安全な完了を受け取り、それが下流のLLM呼び出しに伝播しないことを検証してください。                              |  1  | D/V |
| 2.4.3 | リクエスト時に解決される属性ベースのルールを通じて、ユーザー固有のポリシー（年齢、地域の法的制約など）が審査で遵守されていることを検証します。                          |  2  |  D  |
| 2.4.4 | スクリーニングログにSOC相関および将来のレッドチーム再生のための分類器の信頼度スコアとポリシーカテゴリタグが含まれていることを確認してください。                        |  3  |  V  |

---

## C2.5 入力レート制限と不正利用防止

開発者は、入力率を制限し、異常な使用パターンを検出することで、AIシステムに対する悪用、リソース枯渇、自動化された攻撃を防ぐべきです。

|   #   | 説明                                                                 | レベル | 役割  |
| :---: | ------------------------------------------------------------------ | :-: | :-: |
| 2.5.1 | すべての入力エンドポイントに対して、ユーザーごと、IPごと、およびAPIキーごとのレート制限が適用されていることを確認してください。 |  1  | D/V |
| 2.5.2 | DoSおよびブルートフォース攻撃を防ぐために、バーストおよび持続レート制限が適切に調整されていることを確認してください。       |  2  | D/V |
| 2.5.3 | 異常な使用パターン（例：連続リクエスト、入力の過剰送信）が自動ブロックやエスカレーションを引き起こすことを検証してください。     |  2  | D/V |
| 2.5.4 | 悪用防止ログが保持され、新たに発生する攻撃パターンのためにレビューされていることを確認してください。                 |  3  |  V  |

---

## C2.6 マルチモーダル入力検証

AIシステムは、注入、回避、またはリソースの乱用を防止するために、非テキスト入力（画像、音声、ファイル）に対する堅牢な検証を含めるべきです。

|   #   | 説明                                                                                                                  | レベル | 役割  |
| :---: | ------------------------------------------------------------------------------------------------------------------- | :-: | :-: |
| 2.6.1 | すべての非テキスト入力（画像、音声、ファイル）が処理前にタイプ、サイズ、およびフォーマットで検証されていることを確認してください。                                                   |  1  |  D  |
| 2.6.2 | ファイルが取り込み前にマルウェアおよびステガノグラフィックペイロードのスキャンを受けていることを検証してください。                                                           |  2  | D/V |
| 2.6.3 | 画像/音声入力が敵対的摂動や既知の攻撃パターンについて検査されていることを確認してください。                                                                      |  2  | D/V |
| 2.6.4 | マルチモーダル入力検証の失敗がログに記録され、調査のためのアラートが発生することを確認してください。                                                                  |  3  |  V  |
| 2.6.5 | クロスモーダル攻撃検出が、複数の入力タイプにまたがる協調攻撃（例：画像内のステガノグラフィックペイロードとテキスト内のプロンプトインジェクションの組み合わせ）を相関ルールおよびアラート生成によって特定できることを検証してください。 |  2  | D/V |
| 2.6.6 | マルチモーダル検証の失敗が、すべての入力モダリティ、検証結果、および脅威スコアを含む詳細なログ記録をトリガーすることを確認してください。                                                |  3  | D/V |
---

## C2.7 リアルタイム適応型脅威検出

開発者は、新しい攻撃パターンに適応し、コンパイルされたパターンマッチングによるリアルタイム保護を提供する高度な脅威検出システムをAIに適用すべきです。

|   #   | 説明                                                               | レベル | 役割  |
| :---: | ---------------------------------------------------------------- | :-: | :-: |
| 2.7.1 | パターンマッチング（例：コンパイル済み正規表現）が、すべての入力に対して最小限のレイテンシ影響で動作することを検証してください。 |  1  | D/V |
| 2.8.3 | 適応型検出モデルが最近の攻撃活動に基づいて感度を調整し、新しいパターンでリアルタイムに更新されることを検証してください。     |  2  | D/V |
| 2.8.4 | ユーザー履歴、ソース、およびセッションの行動の文脈分析を通じて検出精度が向上していることを確認してください。           |  3  | D/V |
| 2.8.5 | 検出性能指標（検出率、誤検知率、処理遅延）が継続的に監視および最適化されていることを確認してください。              |  3  | D/V |

---

## 参考文献

* [Generative AI's Biggest Security Flaw Is Not Easy to Fix](https://www.wired.com/story/generative-ai-prompt-injection-hacking)
* [Many-shot jailbreaking \ Anthropic](https://www.anthropic.com/research/many-shot-jailbreaking)
* [OpenAI GPT-4.5 System Card](https://cdn.openai.com/gpt-4-5-system-card-2272025.pdf)
* [Notebook for the CheckThat Lab at CLEF 2024](https://ceur-ws.org/Vol-3740/paper-53.pdf)
* [Mitigate jailbreaks and prompt injections – Anthropic](https://docs.anthropic.com/en/docs/test-and-evaluate/strengthen-guardrails/mitigate-jailbreaks)
* [Chapter 3 MITRE ATT\&CK – Adversarial Model Analysis](https://ama.drwhy.ai/mitre-attck.html)
* [OWASP Top 10 for LLM Applications 2025 – WorldTech IT](https://wtit.com/blog/2025/04/17/owasp-top-10-for-llm-applications-2025/)
* [OWASP Machine Learning Security Top Ten](https://owasp.org/www-project-machine-learning-security-top-10/)
* [Few words about AI Security – Jussi Metso](https://www.jussimetso.com/index.php/2024/09/28/few-words-about-ai-security/)
* [How To Ensure LLM Output Adheres to a JSON Schema | Modelmetry](https://modelmetry.com/blog/how-to-ensure-llm-output-adheres-to-a-json-schema)
* [AI Safety + Cybersecurity R\&D Tracker – Fairly AI](https://www.fairly.ai/blog/ai-cybersecurity-tracker)
* [Anthropic makes 'jailbreak' advance to stop AI models producing harmful results](https://www.ft.com/content/cf11ebd8-aa0b-4ed4-945b-a5d4401d186e)
* [Pattern matching filter rules - IBM](https://www.ibm.com/docs/ssw_aix_71/security/intrusion_pattern_matching_filter_rules.html)
* [Real-time Threat Detection](https://www.darktrace.com/cyber-ai-glossary/real-time-threat-detection)

