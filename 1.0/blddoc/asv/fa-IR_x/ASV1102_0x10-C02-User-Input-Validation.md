# اعتبارسنجی ورودی کاربر C2

## هدف کنترل

اعتبارسنجی قوی ورودی کاربر یک خط دفاعی اول در برابر برخی از مخرب‌ترین حملات به سیستم‌های هوش مصنوعی است. حملات تزریق دستور می‌توانند دستورالعمل‌های سیستم را لغو کنند، داده‌های حساس را فاش کنند یا مدل را به سمت رفتاری غیرمجاز هدایت کنند. مگر اینکه فیلترهای اختصاصی و اعتبارسنجی‌های دیگر برقرار باشند، تحقیقات نشان می‌دهد که فرار از محدودیت‌ها که از پنجره‌های زمینه سوءاستفاده می‌کنند، همچنان مؤثر خواهند بود.

---

## دفاع در برابر تزریق دستور C2.1

تزریق پرامپت یکی از بزرگ‌ترین ریسک‌ها برای سیستم‌های هوش مصنوعی است. دفاع در برابر این روش از ترکیبی از فیلترهای الگو، دسته‌بندی داده‌ها و اجرای سلسله‌مراتب دستوری استفاده می‌کند.

|   #   | توضیحات                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | سطح | نقش |
| :---: | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :-: | :-: |
| 2.1.1 | تأیید کنید که هر ورودی خارجی یا مشتق شده که ممکن است رفتار را هدایت کند، از جمله دستورات کاربر، نتایج RAG، خروجی‌های افزونه یا MCP، پیام‌های عامل به عامل، پاسخ‌های API یا webhook، فایل‌های پیکربندی یا سیاست، خواندن‌ها و نوشتن‌های حافظه، به عنوان غیرقابل اعتماد در نظر گرفته شده، با استفاده از نقل قول یا برچسب‌گذاری و حذف محتوای فعال غیرفعال شده و قبل از ادغام در دستورات یا اجرای اقدامات، با مجموعه قوانین یا سرویس تشخیص تزریق فرمان به‌روز شده بررسی شود. |  1  | D/V |
| 2.1.2 | اطمینان حاصل کنید که سیستم یک سلسله‌مراتب دستوری را اعمال می‌کند که در آن پیام‌های سیستم و توسعه‌دهنده دستورالعمل‌های کاربر و ورودی‌های غیرقابل اعتماد دیگر را، حتی پس از پردازش دستورالعمل‌های کاربر، لغو می‌کنند.                                                                                                                                                                                                                                                     |  1  | D/V |
| 2.1.3 | اطمینان حاصل کنید که پرامپت‌های ناشی از محتوای شخص ثالث (صفحات وب، PDFها، ایمیل‌ها) به صورت جداگانه پاک‌سازی شده‌اند (برای مثال، حذف دستورات شبیه دستورالعمل و خنثی‌سازی محتوای HTML، Markdown و اسکریپت) قبل از اینکه به پرامپت اصلی متصل شوند.                                                                                                                                                                                                                        |  2  |  D  |

---

## C2.2 مقاومت در برابر نمونه‌های متخاصم

مدل‌های پردازش زبان طبیعی (NLP) هنوز در برابر تغییرات ظریف در سطح کاراکتر یا کلمه که انسان‌ها اغلب متوجه آن نمی‌شوند اما مدل‌ها معمولاً آنها را اشتباه طبقه‌بندی می‌کنند، آسیب‌پذیر هستند.

|   #   | توضیحات                                                                                                                                                                                                                                                                                                       | سطح | نقش |
| :---: | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :-: | :-: |
| 2.2.1 | اطمینان حاصل کنید که مراحل پایه ای نرمال‌سازی ورودی (Unicode NFC، نگاشت هوموگلایف، حذف فاصله‌های اضافی، حذف کاراکترهای کنترل و نامرئی یونیکد) قبل از توکنیزه کردن یا تعبیه‌سازی و قبل از تجزیه به پارامترهای ابزار یا MCP اجرا می‌شوند.                                                                       |  1  |  D  |
| 2.2.2 | بررسی کنید که تشخیص ناهنجاری آماری ورودی‌هایی را که فاصله ویرایشی غیرعادی بالا نسبت به هنجارهای زبانی یا فاصله‌های جاسازی غیرطبیعی دارند، علامت‌گذاری می‌کند و ورودی‌های علامت‌گذاری شده قبل از الحاق به پرامپت‌ها یا اجرای اقدامات، مسدود می‌شوند.                                                           |  2  | D/V |
| 2.2.3 | اطمینان حاصل کنید که خط لوله استنتاج از نسخه‌های مدل مقاوم‌شده با آموزش خصمانه یا لایه‌های دفاعی (مانند تصادفی‌سازی، تقطیر دفاعی، بررسی‌های همسویی) برای نقاط انتهایی با ریسک بالا پشتیبانی می‌کند.                                                                                                           |  2  |  D  |
| 2.2.4 | اطمینان حاصل کنید که ورودی‌های مظنون به حمله‌ی مخرب قرنطینه شده و با بار کامل و متادیتای ردیابی (منبع، ابزار یا سرور MCP، شناسه‌ی عامل، جلسه) ثبت می‌شوند.                                                                                                                                                    |  2  |  V  |
| 2.2.5 | اطمینان حاصل کنید که قاچاق رمزگذاری و نمایش در هر دو ورودی‌ها و خروجی‌ها (مانند کاراکترهای یونیکد/کنترلی نامرئی، جایگزینی هم‌ریشه‌ها، یا متن با جهت‌های مختلط) شناسایی و به‌طور مؤثر کاهش یابد. راهکارهای تاییدشده شامل استانداردسازی، صحت‌سنجی دقیق ساختار، رد مبتنی بر سیاست، یا نشانه‌گذاری صریح می‌باشند. |  2  | D/V |

---

## C2.3 مجموعه کاراکترهای فرمان

محدود کردن مجموعه کاراکترهای ورودی کاربران به تنها کاراکترهایی که برای نیازهای کسب‌وکار ضروری هستند، می‌تواند به جلوگیری از انواع مختلف حملات کمک کند.

|   #   | توضیحات                                                                                                                                                             | سطح | نقش |
| :---: | ------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :-: | :-: |
| 2.3.1 | تأیید کنید که سیستم محدودیتی در مجموعه کاراکترهای ورودی کاربران اعمال می‌کند که فقط کاراکترهایی را مجاز می‌داند که به‌طور صریح برای اهداف کسب‌وکار لازم هستند.      |  1  |  D  |
| 2.3.2 | اطمینان حاصل کنید که از رویکرد لیست مجاز برای تعریف مجموعه کاراکترهای مجاز استفاده شده است.                                                                         |  1  |  D  |
| 2.3.3 | اطمینان حاصل کنید که ورودی‌هایی که حاوی کاراکترهای خارج از مجموعه مجاز هستند رد شده و همراه با متاداده ردیابی (منبع، ابزار یا سرور MCP، شناسه عامل، جلسه) ثبت شوند. |  1  | D/V |

---

## اعتبارسنجی طرح‌واره، نوع و طول C2.4

حملات هوش مصنوعی با ورودی‌های نادرست یا بزرگ می‌توانند باعث خطاهای تحلیل، تراوش درخواست‌ها در فیلدها و تمام شدن منابع شوند. اجرای دقیق و سخت‌گیرانه‌ی طرحواره نیز هنگام انجام فراخوانی‌های قطعی ابزار الزامی است.

|   #   | توضیحات                                                                                                                                                                                                                                                           | سطح | نقش |
| :---: | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :-: | :-: |
| 2.4.1 | بررسی کنید که هر API، ابزار یا نقطه پایانی MCP دارای یک ساختار ورودی صریح (JSON Schema، Protobuf یا معادل چندوجهی آن) باشد که فیلدهای اضافی یا ناشناخته و تبدیل نوع ضمنی را رد کند و ورودی‌ها را قبل از تشکیل پرامپت یا اجرای ابزار در سمت سرور اعتبارسنجی نماید. |  1  |  D  |
| 2.4.2 | اطمینان حاصل کنید که ورودی‌هایی که از حداکثر حد توکن یا بایت فراتر می‌روند با خطای ایمن رد شده و هرگز به‌طور بی‌صدا قطع نمی‌شوند.                                                                                                                                 |  1  | D/V |
| 2.4.3 | اطمینان حاصل کنید که بررسی نوع‌ها (مانند بازه‌های عددی، مقادیر شمارشی، نوع MIME برای تصاویر/صدا) در سمت سرور اعمال می‌شوند، از جمله برای پارامترهای ابزار یا MCP.                                                                                                 |  2  | D/V |
| 2.4.4 | اطمینان حاصل کنید که اعتبارسنج‌های معنایی که ورودی‌های پردازش زبان طبیعی (NLP) را می‌فهمند، در زمان ثابت اجرا می‌شوند و از تماس‌های شبکه خارجی اجتناب می‌کنند تا از بروز حملات رفع خدمت الگوریتمی (DoS) جلوگیری شود.                                              |  2  |  D  |
| 2.4.5 | اطمینان حاصل کنید که شکست‌های تأیید اعتبار با قطعات بارگزاری شده سانسور شده و کدهای خطای بدون ابهام ثبت می‌شوند و شامل فراداده ردیابی (منبع، ابزار یا سرور MCP، شناسه عامل، جلسه) هستند تا به سهولت رسیدگی امنیتی کمک کنند.                                       |  3  |  V  |

---

## C2.5 بررسی محتوا و سیاست‌ها

توسعه‌دهندگان باید قادر باشند پرامپت‌های نحوی معتبر که درخواست محتوای ممنوعه (مانند دستورالعمل‌های غیرقانونی، سخنان نفرت‌انگیز و/یا متن‌های دارای حق نشر) را دارند شناسایی کنند و سپس از انتشار آنها جلوگیری نمایند.

|   #   | توضیحات                                                                                                                                                                                                                                                                    | سطح | نقش |
| :---: | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :-: | :-: |
| 2.5.1 | اطمینان حاصل کنید که یک طبقه‌بند محتوا (صفر شات یا با تنظیم دقیق) هر ورودی و خروجی را از نظر خشونت، خودآسیب‌رسانی، نفرت، محتوای جنسی و درخواست‌های غیرقانونی با آستانه‌های قابل تنظیم ارزیابی می‌کند.                                                                      |  1  |  D  |
| 2.5.2 | تأیید کنید که ورودی‌هایی که با سیاست‌ها مغایرت دارند رد خواهند شد تا به تماس‌های LLM یا ابزار/MCP پایین‌دستی منتقل نشوند.                                                                                                                                                  |  1  | D/V |
| 2.5.3 | اطمینان حاصل کنید که غربالگری سیاست‌های خاص کاربر (سن، محدودیت‌های قانونی منطقه‌ای) را از طریق قوانین مبتنی بر ویژگی که در زمان درخواست حل می‌شوند، از جمله ویژگی‌های نقش نماینده رعایت می‌کند.                                                                            |  2  |  D  |
| 2.5.4 | اطمینان حاصل کنید که لاگ‌های غربالگری شامل امتیازهای اطمینان طبقه‌بندی‌کننده و برچسب‌های دسته‌بندی سیاست با مرحله اعمال شده (قبل از پرامپت یا پس از پاسخ) و داده‌های ردگیری (منبع، ابزار یا سرور MCP، شناسه عامل، جلسه) برای همبستگی SOC و بازپخش‌های آینده تیم قرمز باشد. |  3  |  V  |

---

## C2.6 محدود کردن نرخ ورودی و جلوگیری از سوءاستفاده

توسعه‌دهندگان باید از سوءاستفاده، خستگی منابع و حملات خودکار علیه سیستم‌های هوش مصنوعی با محدود کردن نرخ ورودی‌ها و شناسایی الگوهای استفاده غیرعادی جلوگیری کنند.

|   #   | توضیحات                                                                                                                                                                                                                                           | سطح | نقش |
| :---: | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :-: | :-: |
| 2.6.1 | اطمینان حاصل کنید که محدودیت‌های نرخ برای هر کاربر، هر IP، هر کلید API، هر عامل و هر جلسه/وظیفه برای تمامی ورودی‌ها و نقاط انتهایی ابزار/MCP اعمال می‌شوند.                                                                                       |  1  | D/V |
| 2.6.2 | تأیید کنید که محدودیت‌های نرخ انفجاری و پایدار به گونه‌ای تنظیم شده‌اند که از حملات DoS و بروت فورس جلوگیری کنند، و اینکه بودجه‌های هر وظیفه (برای مثال تعداد توکن‌ها، تماس‌های ابزار/MCP، و هزینه) برای حلقه‌های برنامه‌ریزی عامل اعمال می‌شوند. |  2  | D/V |
| 2.6.3 | تأیید کنید که الگوهای استفاده غیرعادی (مانند درخواست‌های سریع پشت سر هم، پر کردن ورودی، تماس‌های مکرر با ابزار/MCP که شکست می‌خورند یا حلقه‌های بازگشتی عامل) باعث فعال شدن بلوک‌های خودکار یا ارتقاء می‌شوند.                                    |  2  | D/V |
| 2.6.4 | تأیید کنید که گزارش‌های جلوگیری از سوءاستفاده نگه‌داری و برای الگوهای حمله نوظهور بازبینی می‌شوند، همراه با فراداده‌های ردگیری (منبع، ابزار یا سرور MCP، شناسه عامل، جلسه).                                                                       |  3  |  V  |

---

## C2.7 اعتبارسنجی ورودی چندحالته

سیستم‌های هوش مصنوعی باید اعتبارسنجی قوی برای ورودی‌های غیرمتنی (تصاویر، صدا، فایل‌ها) داشته باشند تا از تزریق، دور زدن، یا سوء استفاده از منابع جلوگیری شود.

|   #   | توضیحات                                                                                                                                                                                                                                                                                                                                 | سطح | نقش |
| :---: | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :-: | :-: |
| 2.7.1 | اطمینان حاصل کنید که تمام ورودی‌های غیر متنی (تصاویر، صدا، فایل‌ها) از نظر نوع، اندازه و قالب قبل از پردازش بررسی می‌شوند، و هر متنی که استخراج شده است (تبدیل تصویر به متن یا تبدیل گفتار به متن) و هر دستور پنهان یا جاسازی شده (فراداده، لایه‌ها، متن جایگزین، نظرات) مطابق با بند 2.1.1 به عنوان غیرقابل اعتماد در نظر گرفته شوند.  |  1  |  D  |
| 2.7.2 | اطمینان حاصل شود که فایل‌ها قبل از وارد شدن اسکن می‌شوند تا بدافزار و بارهای مخفی شده استگانوگرافیک شناسایی شوند، و هر محتوای فعال (مانند اسکریپت‌ها یا ماکروها) حذف شده یا فایل در قرنطینه قرار گیرد.                                                                                                                                  |  2  | D/V |
| 2.7.3 | اطمینان حاصل کنید که ورودی‌های تصویر/صدا برای تغییرات مخرب یا الگوهای حمله شناخته شده بررسی می‌شوند و تشخیص‌ها باعث فعال‌سازی محدودیت (مسدود کردن یا کاهش قابلیت‌ها) قبل از استفاده از مدل می‌شوند.                                                                                                                                     |  2  | D/V |
| 2.7.4 | اطمینان حاصل کنید که شکست‌های اعتبارسنجی ورودی چندحالتی ثبت می‌شوند و هشدارهایی را برای بررسی ایجاد می‌کنند، همراه با فراداده ردیابی (منبع، ابزار یا سرور MCP، شناسه عامل، جلسه).                                                                                                                                                       |  3  |  V  |
| 2.7.5 | تأیید کنید که تشخیص حملات چندرسانه‌ای، حملات هماهنگ شده‌ای که چندین نوع ورودی را دربرمی‌گیرند (مثلاً حامل‌های استگانوگرافیک در تصاویر همراه با تزریق دستورات در متن) با استفاده از قوانین همبستگی و تولید هشدارها شناسایی می‌کند، و همچنین مطمئن شوید که تشخیص‌های تایید شده مسدود می‌شوند یا نیاز به تأیید انسان در حلقه (HITL) دارند. |  2  | D/V |
| 2.7.6 | بررسی کنید که خطاهای اعتبارسنجی چندوجهی باعث ایجاد گزارش‌گیری دقیق شوند که شامل تمامی حالت‌های ورودی، نتایج اعتبارسنجی و امتیازات تهدید، و همچنین فراداده ردگیری (منبع، ابزار یا سرور MCP، شناسه عامل، جلسه) باشد.                                                                                                                      |  3  | D/V |
---

## C2.8 تشخیص تهدید تطبیقی در زمان واقعی

توسعه‌دهندگان باید از سیستم‌های پیشرفته تشخیص تهدید برای هوش مصنوعی استفاده کنند که به الگوهای حمله جدید سازگار شده و با تطبیق الگوهای کامپایل‌شده، حفاظت در زمان واقعی ارائه دهند.

|   #   | توضیحات                                                                                                                                                                                                                                                                                 | سطح | نقش |
| :---: | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :-: | :-: |
| 2.8.1 | تأیید کنید که الگوبرداری (مثلاً regex کامپایل شده) روی تمام ورودی‌ها و خروجی‌ها (شامل سطوح ابزار/MCP) با کمترین تأثیر بر تأخیر اجرا شود.                                                                                                                                                |  1  | D/V |
| 2.8.3 | اطمینان حاصل کنید که مدل‌های تشخیص تطبیقی حساسیت خود را بر اساس فعالیت‌های حمله اخیر تنظیم می‌کنند و با الگوهای جدید به‌صورت بلادرنگ به‌روزرسانی می‌شوند و واکنش‌های تطبیقی مبتنی بر ریسک را فعال می‌کنند (برای مثال غیرفعال کردن ابزارها، کاهش زمینه، یا نیاز به تأیید انسان در حلقه). |  2  | D/V |
| 2.8.4 | تأیید کنید که دقت تشخیص از طریق تحلیل زمینه‌ای تاریخچه کاربر، منبع، و رفتار جلسه، از جمله فراداده‌های ردیابی (منبع، ابزار یا سرور MCP، شناسه نماینده، جلسه) بهبود یافته است.                                                                                                            |  3  | D/V |
| 2.8.5 | اطمینان حاصل کنید که معیارهای عملکرد شناسایی (نرخ شناسایی، نرخ مثبت کاذب، تأخیر پردازش) به طور مداوم تحت نظارت و بهینه‌سازی قرار دارند، از جمله زمان مسدودسازی و مرحله (قبل از درخواست/بعد از پاسخ).                                                                                    |  3  | D/V |

## مراجع

* [OWASP LLM01:2025 Prompt Injection](https://genai.owasp.org/llmrisk/llm01-prompt-injection/)
* [LLM Prompt Injection Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/LLM_Prompt_Injection_Prevention_Cheat_Sheet.html)
* [MITRE ATLAS : Adversarial Input Detection](https://atlas.mitre.org/mitigations/AML.M00150)
* [Mitigate jailbreaks and prompt injections](https://docs.anthropic.com/en/docs/test-and-evaluate/strengthen-guardrails/mitigate-jailbreaks)

